<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="js/godebug.js"></script>
    <!-- <link rel='stylesheet' href='./bootstrap.min.css' />
    <script src='./bootstrap.min.js'></script>
    <script src="./jquery.min.js"></script> -->
    <link href="js/bootstrap.min.css" rel="stylesheet">

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script> -->

    <script>
        let nodeDataArray = [] //表数据信息
        let filedInfos = [] //所有字段信息
        let linkDataArray = [] //表关系信息
            //用于生成模型图
        function makeImage() {
            let tempFieldList = []
            console.log('生成模型', document.getElementById("modelName").value);
            const tableName = document.getElementById("modelName").value
            if (!tableName) {
                alert("表名不能为空")
            } else {
                const filedLen = document.getElementById('mytable').rows
                console.log('所有的字段信息长度', filedLen.length);
                for (let i = 1; i < filedLen.length; i++) {
                    console.log('----单行有多少列', filedLen[i].cells.length);
                    let tempField = {}
                    for (let j = 0; j < filedLen[i].cells.length; j++) {

                        //单行每列的值
                        const cowInfo = filedLen[i].cells[j].innerHTML;
                        console.log('单行每列的值', cowInfo);
                        switch (j) {
                            case 0:
                                tempField['name'] = cowInfo
                                break;
                            case 1:
                                tempField['info'] = cowInfo
                                break;
                            case 2:
                                tempField['defaultValue'] = cowInfo
                                break;
                            case 3:
                                tempField['isNull'] = cowInfo
                                break;
                            case 4:
                                tempField['isPrimary'] = cowInfo
                                break;
                            case 5:
                                tempField['isForeign'] = cowInfo
                                break;

                            default:
                                break;
                        }

                        // tempField[j + 1] = cowInfo
                    }
                    tempFieldList.push(tempField)
                }
                console.log('----tempFieldList', tempFieldList);
                /*
                计算表模型的位置
                localPostionY  Y轴位置
                localPostionX  X轴位置
                */
                let localPostionY = parseInt(nodeDataArray.length / 5) * 200
                let localPostionX = (nodeDataArray.length % 5 - 1) * 300



                /*
                表的基本数据
                */
                nodeDataArray.push({
                        key: tableName,
                        fields: tempFieldList,
                        loc: localPostionX + " " + localPostionY //位置
                    })
                    /*
                    表关系的数据
                    */
                document.getElementById("iframStyleId").src = `/datamodel?nodeDataArray=${JSON.stringify(nodeDataArray)}&linkDataArray=${JSON.stringify(linkDataArray)}`;
                // window.location.reload() //刷新整个页面
                //输入框清空
                $('input').val("")
                    //勾选框清空
                $("input:checked").each(function() {
                    this.checked = false;
                });
                //清空表格
                $("#mytable  tr:not(:first)").remove()
            }
        }

        //获取外键关联表的关联字段
        function getNowField() {
            $('#selectSignField').find('li').remove()
            const presentTable = document.getElementById('tableRelation').value
            console.log('当前的关联的表名', presentTable);
            for (let i = 0; i < nodeDataArray.length; i++) {
                if (nodeDataArray[i].key === presentTable) {
                    console.log('存在表名相同');
                    const presentFields = nodeDataArray[i].fields
                    for (let j = 0; j < presentFields.length; j++) {
                        const nowField = presentFields[j].name
                        console.log('关联表的每个字段名称', nowField);
                        $('#selectSignField').append('<li><a href="#" id="forignKeyRelField">' + nowField + '</a></li>')
                    }
                }
            }
        }

        //外键关系获取所有的表
        function getTables() {
            $('#selectSignTable').find('li').remove()
            for (let i = 0; i < nodeDataArray.length; i++) {
                $('#selectSignTable').append('<li><a href="#" id="forignKeyRel">' + nodeDataArray[i].key + '</a></li>')
            }

        }


        function addTable() {
            let filedListInfo = []

            const filedName = document.getElementById('filedName').value
            const typeName = document.getElementById('fileTypeName').value
            if (!filedName || !typeName) {
                alert("字段或类型不能为空")
            } else {
                filedListInfo.push(filedName)



                filedListInfo.push(typeName)
                const defaultName = document.getElementById('defaultName').value
                filedListInfo.push(defaultName)

                // 复选框
                const checkList = $('input:checkbox')
                for (let i = 0; i < checkList.length; i++) {
                    if (checkList[i].value === "true") {
                        filedListInfo.push('true')
                    } else {
                        filedListInfo.push('false')
                    }
                }

                var c = document.getElementById('mytable'); //获得表格的信息
                const tabelLen = c.rows.length
                if (c.rows.length == 0) { //如果是向一个空表增加一行
                    var x = c.insertRow(0); //向空表插入一行
                    var y = x.insertCell(0); //向新行插入一列
                    y.innerHTML = "new cell0";
                } else {
                    var z = c.rows[0].cells; //如果不是空表，首先获得表格有多少列，先获取再插入新行
                    var x = c.insertRow(tabelLen);

                    for (var i = 0; i < z.length; i++) { //依次向新行插入表格列数的单元格
                        var y = x.insertCell(i);
                        y.innerHTML = filedListInfo[i];
                    }
                }
            }
            //输入框清空
            $('input').val("")
                //勾选框清空
            $("input:checked").each(function() {
                this.checked = false;
            });

        }

        function delTable() {
            var x = document.getElementById("mytable");
            const tabelLen = x.rows.length
            if (tabelLen > 1) {
                x.deleteRow(tabelLen - 1); //删除一行
            }
        }



        //解决jQuery append后无法获取
        $(document).on("click", "#forignKeyRel", function() {
            $("div#selectTable").siblings("input").val($(this).html())
        })
        $(document).on("click", "#forignKeyRelField", function() {
            $("div#selectField").siblings("input").val($(this).html())
        })

        $(document).ready(function() {
            $("[name='allTypeInfo']").click(function() {
                $("div#selectType").siblings("input").val($(this).html());
            });

            $("input[name=isNullSelect]").click(function() {
                if ($('input:checkbox[name="isNullSelect"]:checked').length > 0) {
                    $(this).attr("value", "true")
                } else {
                    $(this).attr("value", "false")
                }
            });
            $("input[name=isPrimarySelect]").click(function() {
                if ($('input:checkbox[name="isPrimarySelect"]:checked').length > 0) {
                    $(this).attr("value", "true")
                } else {
                    $(this).attr("value", "false")
                }
            });
            $("input[name=isForeignSelect]").click(function() {
                if ($('input:checkbox[name="isForeignSelect"]:checked').length > 0) {
                    $(this).attr("value", "true")
                    document.getElementById('tableRel').style.display = 'inline'
                    document.getElementById('fieldRel').style.display = 'inline'
                } else {
                    $(this).attr("value", "false")
                    document.getElementById('tableRel').style.display = 'none'
                    document.getElementById('fieldRel').style.display = 'none'
                }
            });
        });
    </script>
</head>

<body>
    <div style="width:100%; height:50px;float:left; text-align: center;font-size: xx-large; background-color:#c9bcca;">
        模型
    </div>
    <div style="width:70%; height:1200px;float:left; background-color:#ecf3f3;">
        <iframe frameborder="0" class="iframStyle" height="100%" width="100%" id="iframStyleId">页面</iframe>
    </div>
    <div id="myLISTDiv" style="width:30%; height:1200px;float:left; background-color:#278a8a;">
        <div class="input-group" style="margin-top: 20px;margin-left: 25px; width: 50%;">
            <span class="input-group-addon" id="basic-addon1">模型名称</span>
            <input type="text" class="form-control" placeholder="" aria-describedby="basic-addon1" id="modelName">
        </div>



        <div class="row" style="margin-top: 20px;margin-left: 10px;">
            <div class="col-lg-6">
                <div class="input-group">
                    <div class="input-group-btn" id="selectType">
                        <button type="button" id="selectButtonType" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            字段类型 
                            <span class="caret"></span>
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu" id="selectSign">
                            <li><a href="#" name="allTypeInfo">String</a></li>
                            <li><a href="#" name="allTypeInfo">Int</a></li>
                            <li><a href="#" name="allTypeInfo">Boolean</a></li>
                            <li><a href="#" name="allTypeInfo">Enum</a></li>
                        </ul>
                    </div>
                    <input type="text" id="fileTypeName" class="form-control" aria-label="..." placeholder="">
                    <!-- <input type="text" id="fileTypeName" class="form-control" aria-label="..." placeholder="" value="String"> -->
                </div>
            </div>
        </div>

        <div id="" class="container" style="margin-top: 20px;margin-left: 10px; width: 300px;">
            <label>字段名称</label>
            <input type="text" name="filedName" id="filedName" value="" class="form-control" />
            <label>默认值</label>
            <input type="text" name="defaultName" id="defaultName" value="" class="form-control" />
        </div>
        <div class="checkbox" style="margin-top: 20px;margin-left: 25px;">
            <label for="">
                <input type="checkbox" name="isNullSelect" value="false">是否为NULL
            </label>
            <label for="">
                <input type="checkbox" name="isPrimarySelect" value="false">是否为主键
            </label>
            <label for="">
                <input type="checkbox"  name="isForeignSelect" value="false">是否为外键
            </label>
        </div>
        <div class="row" style="margin-top: 20px;margin-left: 10px; display: none;" id="tableRel">
            <div class="col-lg-6">
                <div class="input-group">
                    <div class="input-group-btn" id="selectTable">
                        <button type="button" id="selectButtonTable" onclick="getTables()" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            关联表
                            <span class="caret"></span>
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu" id="selectSignTable">
                        </ul>
                    </div>
                    <input type="text" id="tableRelation" class="form-control" aria-label="..." placeholder="" value="">
                </div>
            </div>
        </div>

        <div class="row" style="margin-top: 20px;margin-left: 10px; display: none;" id="fieldRel">
            <div class="col-lg-6">
                <div class="input-group">
                    <div class="input-group-btn" id="selectField">
                        <button type="button" id="selectButtonField" onclick="getNowField()" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                            关联字段
                            <span class="caret"></span>
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu" id="selectSignField">
                        </ul>
                    </div>
                    <input type="text" id="fieldRelation" class="form-control" aria-label="..." placeholder="" value="">
                </div>
            </div>
        </div>


        <button class="btn btn-default" onclick="addTable()" type="submit" style="margin-top: 20px; margin-left: 20px;">增加一行</button>
        <button class="btn btn-default" onclick="delTable()" type="submit" style="margin-top: 20px; margin-left: 20px;">删除一行</button>
        <button class="btn btn-default" onclick="makeImage()" type="submit" style="margin-top: 20px; margin-left: 20px;">生成图形</button>

        <table class="table" style="margin-top: 20px; " id="mytable">
            <thead>
                <tr>
                    <th>字段名</th>
                    <th>类型</th>
                    <th>默认值</th>
                    <th>是否为NULL</th>
                    <th>是否为主键</th>
                    <th>是否为外键</th>
                </tr>
            </thead>


        </table>




    </div>



</body>

</html>